var Sprite3D=Sprite3D||{isSupported:function(){!this._isInit&&this._init();return this._isSupported},stage:function(c){!this._isInit&&this._init();var b,a;if(c){b=c;a=c.style;if(a.position==="static")a.position="relative"}else{b=document.createElement("div");a=b.style;a.position="absolute";a.margin="0px";a.padding="0px"}a[this._browserPrefix+"Perspective"]="800px";a[this._browserPrefix+"Transform"]="translateZ(0px)";a[this._browserPrefix+"TransformStyle"]="preserve-3d";return this.create(b)},create:function(a){!this._isInit&&this._init();if(arguments.length===0){a=document.createElement("div");a.style.margin="0px";a.style.padding="0px";a.style.position="absolute"}else if(typeof a==="string"){var b=a;a=document.createElement("div");a.style.margin="0px";a.style.padding="0px";a.style.position="absolute";this._handleStringArgument(a,b)}else if(a.style.position=="static")a.style.position="relative";a.style[this._browserPrefix+"TransformStyle"]="preserve-3d";a.style[this._transformProperty]="translateZ(0px)";a.style[this._browserPrefix+"BackfaceVisibility"]="hidden";for(prop in this._props)if(this._props.hasOwnProperty(prop))a[prop]=this._props[prop];a._string=["translate3d(",0,"px,",0,"px,",0,"px) ","rotateX(",0,"deg) ","rotateY(",0,"deg) ","rotateZ(",0,"deg) ","scale3d(",1,", ",1,", ",1,") "];a._positions=[1,3,5,8,11,14,17,19,21];a._ox=0;a._oy=0;a._oz=0;return a},box:function(a,c,d,h){!this._isInit&&this._init();var b=this.create();if(arguments.length===1){c=a;d=a}else if(arguments.length===2&&typeof arguments[1]==="string"){this._handleStringArgument(b,arguments[1]);c=a;d=a}else h&&typeof h==="string"&&this._handleStringArgument(b,h);var g=a*.5,e=c*.5,f=d*.5;b.appendChild(Sprite3D.create(".front").position(-g,-e,f).size(a,c).update());b.appendChild(Sprite3D.create(".back").position(-g,-e,-f).size(a,c).rotationY(180).update());b.appendChild(Sprite3D.create(".left").position(-g-f,-e,0).size(d,c).rotationY(-90).update());b.appendChild(Sprite3D.create(".right").position(g-f,-e,0).size(d,c).rotationY(90).update());b.appendChild(Sprite3D.create(".bottom").position(-g,e-f,0).size(a,d).rotationX(-90).update());b.appendChild(Sprite3D.create(".top").position(-g,-e-f,0).size(a,d).rotationX(90).update());return b},prefix:function(a){return Sprite3D._browserPrefix+a},_isInit:false,_isSupported:false,_browserPrefix:"webkit",_transformProperty:"webkitTransform",_init:function(){var c=document.createElement("div"),b=["","webkit","Moz","O","ms"],d=b.length,a;Sprite3D._isInit=true;for(a=0;a<d;a++)if(b[a]+"Perspective"in c.style){Sprite3D._transformProperty=b[a]+"Transform";Sprite3D._isSupported=true;Sprite3D._browserPrefix=b[a];if(a==2)Sprite3D._props.update=Sprite3D._props.updateJoin;return true}return false},_handleStringArgument:function(b,a){switch(a[0]){case".":b.className=a.substr(1);break;case"#":b.id=a.substr(1);break;default:b.id=a}},_props:{x:function(a){if(arguments.length){this._string[this._positions[0]]=a-this._ox;return this}else return this._string[this._positions[0]]+this._ox},y:function(a){if(arguments.length){this._string[this._positions[1]]=a-this._oy;return this}else return this._string[this._positions[1]]+this._oy},z:function(a){if(arguments.length){this._string[this._positions[2]]=a-this._oz;return this}else return this._string[this._positions[2]]+this._oz},position:function(a,b,c){this._string[this._positions[0]]=a-this._ox;this._string[this._positions[1]]=b-this._oy;if(arguments.length>=3)this._string[this._positions[2]]=c-this._oz;return this},move:function(a,b,c){this._string[this._positions[0]]+=a;this._string[this._positions[1]]+=b;if(arguments.length>=3)this._string[this._positions[2]]+=c;return this},rotationX:function(a){if(arguments.length){this._string[this._positions[3]]=a;return this}else return this._string[this._positions[3]]},rotationY:function(a){if(arguments.length){this._string[this._positions[4]]=a;return this}else return this._string[this._positions[4]]},rotationZ:function(a){if(arguments.length){this._string[this._positions[5]]=a;return this}else return this._string[this._positions[5]]},rotation:function(a,b,c){this._string[this._positions[3]]=a;this._string[this._positions[4]]=b;this._string[this._positions[5]]=c;return this},rotate:function(a,b,c){this._string[this._positions[3]]+=a;this._string[this._positions[4]]+=b;this._string[this._positions[5]]+=c;return this},scaleX:function(a){if(arguments.length){this._string[this._positions[6]]=a;return this}else return this._string[this._positions[6]]},scaleY:function(a){if(arguments.length){this._string[this._positions[7]]=a;return this}else return this._string[this._positions[7]]},scaleZ:function(a){if(arguments.length){this._string[this._positions[8]]=a;return this}else return this._string[this._positions[8]]},scale:function(a,b,c){switch(arguments.length){case 0:return this._string[this._positions[6]];case 1:this._string[this._positions[6]]=a;this._string[this._positions[7]]=a;this._string[this._positions[8]]=a;return this;case 2:this._string[this._positions[6]]=a;this._string[this._positions[7]]=b;return this;case 3:this._string[this._positions[6]]=a;this._string[this._positions[7]]=b;this._string[this._positions[8]]=c;return this}return this},origin:function(b,d,c){if(typeof b==="string"){var a=window.getComputedStyle(this,null);console.log(a);console.log("w:"+a.getPropertyValue("width")+" || h: "+a.height)}else{if(arguments.length<3)c=0;this._string[this._positions[0]]+=this._ox-b;this._string[this._positions[1]]+=this._oy-d;this._string[this._positions[2]]+=this._oz-c;this._ox=b;this._oy=d;this._oz=c}return this},transformOrigin:function(a,b){this.style[Sprite3D._browserPrefix+"TransformOrigin"]=(Number(a)?a+"px":a)+" "+(Number(b)?b+"px":b);return this},transformString:function(g){var e=g.toLowerCase().split(" "),f=e.length,d=0,c=[],b=[0,0,0,0,0,0,0,0,0],a=0;for(d;d<f;d++)switch(e[d]){case"p":case"position":case"translate":a=c.push("translate3d(",this._string[this._positions[0]],"px,",this._string[this._positions[1]],"px,",this._string[this._positions[2]],"px) ");b[0]=a-6;b[1]=a-4;b[2]=a-2;break;case"rx":case"rotatex":case"rotationx":a=c.push("rotateX(",this._string[this._positions[3]],"deg) ");b[3]=a-2;break;case"ry":case"rotatey":case"rotationy":a=c.push("rotateY(",this._string[this._positions[4]],"deg) ");b[4]=a-2;break;case"rz":case"rotatez":case"rotationz":a=c.push("rotateZ(",this._string[this._positions[5]],"deg) ");b[5]=a-2;break;case"s":case"scale":a=c.push("scale3d(",this._string[this._positions[6]],",",this._string[this._positions[7]],",",this._string[this._positions[8]],") ");b[6]=a-6;b[7]=a-4;b[8]=a-2}this._string=c;this._positions=b;return this},updateJoin:function(){this.style[Sprite3D._transformProperty]=this._string.join("");return this},update:function(){var a="";this._string.every(function(b){a+=b;return true});this.style[Sprite3D._transformProperty]=a;return this},perspective:function(a){switch(arguments.length){case 0:return this.style[Sprite3D._browserPrefix+"Perspective"];case 1:this.style[Sprite3D._browserPrefix+"Perspective"]=typeof a==="string"?a:a+"px";return this}},css:function(a,b){switch(arguments.length){case 0:return this.style;case 1:return this.style[a];case 2:this.style[a]=b;return this;case 3:this.style[Sprite3D._browserPrefix+a]=b;return this}},html:function(a){if(arguments.length){this.innerHTML=a;return this}else return this.innerHTML;return this},size:function(b,a){this.style.width=Number(b)?b+"px":b;this.style.height=Number(a)?a+"px":a;return this},bind:function(a){if(typeof a==="object")for(var b in a)this.addEventListener(b,a[b],false);else arguments.length===2&&this.addEventListener(arguments[0],arguments[1],false);return this},unbind:function(a){if(typeof a==="object")for(var b in a)this.removeEventListener(b,a[b],false);else arguments.length===2&&this.removeEventListener(arguments[0],arguments[1],false);return this},tileWidth:0,tileHeight:0,tileSize:function(b,a){this.tileWidth=b;this.tileHeight=a;return this},tilePosition:function(a,b){this.style.backgroundPosition="-"+a*this.tileWidth+"px -"+b*this.tileHeight+"px";return this},"set":function(b,a){this[b]=a;return this}}};Aroma.Vector3D=function(a,b,c){this.x=a;this.y=b;this.z=c};Aroma.Vector3D.prototype.toString=function(){return String("["+this.x+" ,"+this.y+" ,"+this.z+"]")};Aroma.Vector3D.dotProduct=function(a,b){return a.x*b.x+a.y*b.y+a.z*b.z};Aroma.Vector3D.rotate=function(a,b,c,d){a=Aroma.Vector3D.rotateAxis(a,"x",b);a=Aroma.Vector3D.rotateAxis(a,"y",c);a=Aroma.Vector3D.rotateAxis(a,"z",d);return a};Aroma.Vector3D.rotateAxis=function(a,e,d){d=d*Math.PI/180;var b=Math.cos(d),c=Math.sin(d);switch(e){case"x":return new Aroma.Vector3D(a.x,a.y*b-a.z*c,a.y*c+a.z*b);break;case"y":return new Aroma.Vector3D(a.z*c+a.x*b,a.y,a.z*b-a.x*c);break;case"z":return new Aroma.Vector3D(a.x*b-a.y*c,a.x*c+a.y*b,a.z)}};Aroma.CSS3DView=function(b,a){Aroma.AbstractView.call(this,b,a);this.viewport=document.createElement("div");this.viewport.style.overflow="hidden";this.sort=true;this.stage=Sprite3D.stage();this.alignstage=function(){this.stage.style.position="relative";this.stage.style.left=(this.vpWidth-this.width)/2+"px";this.stage.style.top=(this.vpHeight-this.height)/2+"px"}};Aroma.CSS3DView.prototype=new Aroma.AbstractView;Aroma.CSS3DView.prototype.constructor=Aroma.CSS3DView;Aroma.CSS3DView.prototype.setup=function(){this.stage.perspective(1500);this.stage.style[Sprite3D._browserPrefix+"PerspectiveOrigin"]="50% 50%";this.stage.style[Sprite3D._browserPrefix+"TransformStyle"]="";this.viewport.appendChild(this.stage)};Aroma.CSS3DView.prototype.setSize=function(b,a){Aroma.AbstractView.prototype.setSize.call(this,b,a);this.stage.style.width=b+"px";this.stage.style.height=a+"px";this.alignstage()};Aroma.CSS3DView.prototype.setViewPortSize=function(b,a){this.vpWidth=b;this.vpHeight=a;this.viewport.style.width=b+"px";this.viewport.style.height=a+"px";this.alignstage()};Aroma.CSS3DView.prototype.dispose=function(){this.stage.setAttribute("style","");Aroma.AbstractView.prototype.dispose.call(this)};Aroma.CSS3DView.prototype.getPieceAt=function(b,c,e){var d=this.posToID(b,c);if(this._pieceList[d]!=null)return this._pieceList[d];var a=new Aroma.CSS3DCube,f=this.getPieceBounds(b,c);a.col=b;a.row=c;a.bounds=f;a.view=this;a.stage=this.stage;e.piece=a;ConcatObject.concat(a.options,e.getPieceOptions());a.setup(this.newSource,this.oldSource);this.stage.appendChild(a.cube);this._pieceList[d]=a;return a};Aroma.CSS3DView.prototype.sortParts=function(){Aroma.AbstractView.prototype.sortParts.call(this);for(var a=0,b=this._pieceList.length;a<b;++a)this._pieceList[a].cube.style.zIndex=a};Aroma.CSS3DCube=function(){Aroma.Piece.call(this);this.proxy=null;this.cube=null;this.stage=null;this.depth=0;this.options={flipX:false,flipY:false,sideColor:11184810,newImageLocation:1,depth:800};this.side_dic={right:3,front:0,left:2,back:1,top:5,bottom:4};this.getImage=function(b,c,d){var a=new Image;a.src=b.src;a.style.width=this.view.width+"px";a.style.height=this.view.height+"px";a.style.position="relative";a.style.left=-this.bounds.x+"px";a.style.top=-this.bounds.y+"px";if(c){a.style[Sprite3D._browserPrefix+"Transform"]+=" rotateX(180deg)";a.style.left=-this.view.width+(this.bounds.x+this.bounds.width)+"px"}if(d){a.style[Sprite3D._browserPrefix+"Transform"]+=" rotateY(180deg)";a.style.top=-this.view.height+(this.bounds.y+this.bounds.height)+"px"}return a}};Aroma.CSS3DCube.normals=[new Aroma.Vector3D(0,0,1),new Aroma.Vector3D(0,0,-1),new Aroma.Vector3D(-1,0,0),new Aroma.Vector3D(1,0,0),new Aroma.Vector3D(0,1,0),new Aroma.Vector3D(0,-1,0)];Aroma.CSS3DCube.prototype=new Aroma.Piece;Aroma.CSS3DCube.prototype.constructor=Aroma.CSS3DCube;Aroma.CSS3DCube.light=true;Aroma.CSS3DCube.prototype.setup=function(b,c){this.proxy={x:0,y:0,z:0,rotationX:0,rotationY:0,rotationZ:0,piece:this};this.newSource=b;this.oldSource=c;this.depth=this.options.depth;this.bounds.width=this.bounds.width;this.bounds.height=this.bounds.height;this.bounds.x=this.bounds.x;this.bounds.y=this.bounds.y;this.cube=Sprite3D.box(this.bounds.width,this.bounds.height,this.depth,"cube");this.sides=this.cube.children;for(var a=0;a<6;++a)if(a==0){this.sides[0].style.overflow="hidden";this.sides[0].appendChild(this.getImage(this.oldSource))}else if(a==this.options.newImageLocation){this.sides[a].style.overflow="hidden";this.sides[a].appendChild(this.getImage(this.newSource,this.options.flipX,this.options.flipY))}else this.sides[a].style.backgroundColor="#"+this.options.sideColor.toString(16);this.origin_x=this.bounds.x+this.bounds.width/2;this.origin_y=this.bounds.y+this.bounds.height/2;this.origin_z=-this.depth>>1;this.cube.style.left=this.origin_x+"px";this.cube.style.top=this.origin_y+"px";this.cube.z(this.origin_z);this.cube.update();this.stage.appendChild(this.cube)};Aroma.CSS3DCube.prototype.dispose=function(){this.stage.removeChild(this.cube);this.cube.html("");this.cube=null;this.stage=null;this.scene=null;this.proxy=null};Aroma.CSS3DCube.prototype.proxyUpdate=function(){this.piece.cube.x(this.x);this.piece.cube.y(this.y);this.piece.cube.z(this.z+this.piece.origin_z);this.piece.cube.rotationX(-this.rotationX);this.piece.cube.rotationY(-this.rotationY);this.piece.cube.rotationZ(-this.rotationZ);this.piece.cube.update();if(Aroma.CSS3DCube.light)for(var b=1;b<6;++b)if(b!=this.piece.options.newImageLocation){var d=Aroma.Vector3D.rotate(Aroma.CSS3DCube.normals[b],-this.rotationX,-this.rotationY,-this.rotationZ),a=Aroma.Vector3D.dotProduct(d,Aroma.CSS3DCube.normals[0])*50,c=this.piece.options.sideColor;if(a<0)a=0;this.piece.cube.children[b].style.backgroundColor="rgb("+parseInt((c&255)+a)+","+parseInt((c>>8&255)+a)+","+parseInt((c>>16&255)+a)+")";d=null}}